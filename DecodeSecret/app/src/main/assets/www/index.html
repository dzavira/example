<!DOCTYPE html>
<html>
<head>
    <title>QRCode</title>
    <meta charset="UTF-8" />
<!--    <link rel="stylesheet" type="text/css" href="./default.css" />-->

</head>
<body><div class="main">
<p><input type="file" accept="image/*" id="decode-file" /></p>
<canvas id="decode-canvas"></canvas>
<p>
    <button id="decode-btn">decode</button>
</p>
<p id="decode-text"><textarea readonly></textarea></p>
</div>
<script src="jquery.slim.min.js"></script>
<script type="text/javascript" src="./qrcode.js"></script>
<script type="text/javascript">

      var encodeText = $('#encode-text');
      var encodeMode = $('#encode-mode');
      var encodingHint = $('#encoding-hint');
      var encodeECLevel = $('#encode-eclevel');
      var encodeMargin = $('#encode-margin');
      var encodeMSize = $('#encode-msize');
      var encodeResult = $('#encode-result');

      var hasImage = false;
      var imageData = null;
      var decodeText = $('#decode-text');
      var canvas = $('#decode-canvas')[0];
      var context = canvas.getContext('2d');
      var decodeResult = decodeText.find('textarea');

      function resetDecoder() {
        hasImage = false;
        imageData = null;

        decodeResult.val('');
        decodeText.addClass('hide');
      }

      function drawImage(src) {
          var img = new Image();

          img.crossOrigin = 'anonymous';

          img.onload = function () {
            var width = img.width;
            var height = img.height;
            var actualWidth = Math.min(60, width);
            var actualHeight = height * (actualWidth / width);

            hasImage = true;
            canvas.width = actualWidth;
            canvas.height = actualHeight;

            context.drawImage(img, 0, 0, width, height, 0, 0, actualWidth, actualHeight);

            imageData = context.getImageData(0, 0, actualWidth, actualHeight);
          };
          img.src = src;

      }

      $('#decode-file').on('change', function (e) {
        var file = e.target.files[0];

        if (file) {
          resetDecoder();

          var reader = new FileReader();

          reader.onload = function (e) {
            drawImage(e.target.result);
          };

          reader.readAsDataURL(file);
        }

      });

      function getImageData() {
        imageData && context.putImageData(imageData, 0, 0);
        return imageData || context.getImageData(0, 0, canvas.width, canvas.height);
      }

      function getModuleSize(location, version) {
        var topLeft = location.topLeft;
        var topRight = location.topRight;
        var a = Math.abs(topRight.x - topLeft.x);
        var b = Math.abs(topRight.y - topLeft.y);
        var c = Math.sqrt(Math.pow(a, 2) + Math.pow(b, 2));

        return c / (version * 4 + 17);
      }

      function markFinderPattern(x, y, moduleSize) {
        context.fillStyle = '#00ff00';

        context.beginPath();
        context.arc(x, y, moduleSize * 0.75, 0, 2 * Math.PI);
        context.fill();
      }

      function markQRCodeArea(location, version) {
        context.lineWidth = 2;
        context.strokeStyle = '#00ff00';

        context.beginPath();
        context.moveTo(location.topLeft.x, location.topLeft.y);
        context.lineTo(location.topRight.x, location.topRight.y);
        context.lineTo(location.bottomRight.x, location.bottomRight.y);
        context.lineTo(location.bottomLeft.x, location.bottomLeft.y);
        context.lineTo(location.topLeft.x, location.topLeft.y);
        context.stroke();

        var moduleSize = getModuleSize(location, version);

        markFinderPattern(location.topLeftFinder.x, location.topLeftFinder.y, moduleSize);
        markFinderPattern(location.topRightFinder.x, location.topRightFinder.y, moduleSize);
        markFinderPattern(location.bottomLeftFinder.x, location.bottomLeftFinder.y, moduleSize);
      }

      $('#decode-btn').on('click', function () {
        baca();
      });

      function baca(){
        if (!hasImage) {
          return alert('Please select a QR code image');
        }

        var imageData = getImageData();
        var result = new QRCode.Decoder()
          .setOptions({ canOverwriteImage: false })
          .decode(imageData.data, imageData.width, imageData.height);

        if (result) {
        //  alert(JSON.stringify(result));
          decodeResult.val(result.data);
          decodeText.removeClass('hide'); // tampilkan hasil

          markQRCodeArea(result.location, result.version);

          console && console.log(result);
        } else {
          alert('QR code decoding failed');
        }
      }
      /https?:/i.test(location.protocol) && drawImage('trial.png');
    </script>
</body>
</html>
